<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Express CORS æµ‹è¯•é¡µé¢</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			line-height: 1.6;
			color: #333;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			background: white;
			border-radius: 10px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			overflow: hidden;
		}

		.header {
			background: linear-gradient(135deg, #2c3e50, #3498db);
			color: white;
			padding: 30px;
			text-align: center;
		}

		.header h1 {
			font-size: 2.5em;
			margin-bottom: 10px;
		}

		.header p {
			font-size: 1.2em;
			opacity: 0.9;
		}

		.content {
			padding: 30px;
		}

		.test-section {
			margin-bottom: 40px;
			border: 1px solid #ddd;
			border-radius: 8px;
			overflow: hidden;
		}

		.section-header {
			background: #f8f9fa;
			padding: 15px 20px;
			border-bottom: 1px solid #ddd;
			font-weight: bold;
			font-size: 1.2em;
			color: #2c3e50;
		}

		.section-content {
			padding: 20px;
		}

		.button-group {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-bottom: 20px;
		}

		button {
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 12px 20px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.3s ease;
			min-width: 120px;
		}

		button:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
		}

		button:active {
			transform: translateY(0);
		}

		.btn-danger {
			background: linear-gradient(135deg, #e74c3c, #c0392b);
		}

		.btn-danger:hover {
			box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
		}

		.btn-success {
			background: linear-gradient(135deg, #27ae60, #229954);
		}

		.btn-success:hover {
			box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
		}

		.btn-warning {
			background: linear-gradient(135deg, #f39c12, #e67e22);
		}

		.btn-warning:hover {
			box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
		}

		.result {
			background: #f8f9fa;
			border: 1px solid #ddd;
			border-radius: 5px;
			padding: 15px;
			margin-top: 15px;
			white-space: pre-wrap;
			font-family: 'Courier New', monospace;
			font-size: 13px;
			max-height: 300px;
			overflow-y: auto;
		}

		.success {
			background: #d4edda;
			border-color: #c3e6cb;
			color: #155724;
		}

		.error {
			background: #f8d7da;
			border-color: #f5c6cb;
			color: #721c24;
		}

		.info {
			background: #cce7ff;
			border: 1px solid #b3d7ff;
			color: #004085;
			padding: 15px;
			border-radius: 5px;
			margin-bottom: 20px;
		}

		.status-indicator {
			display: inline-block;
			width: 10px;
			height: 10px;
			border-radius: 50%;
			margin-right: 8px;
		}

		.status-success {
			background: #28a745;
		}

		.status-error {
			background: #dc3545;
		}

		.status-warning {
			background: #ffc107;
		}

		.cors-explanation {
			background: #e9ecef;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 30px;
		}

		.cors-explanation h3 {
			color: #495057;
			margin-bottom: 15px;
		}

		.cors-explanation ul {
			padding-left: 20px;
		}

		.cors-explanation li {
			margin-bottom: 8px;
		}

		input[type="text"],
		input[type="url"] {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-size: 14px;
			margin-bottom: 10px;
		}

		.flex-row {
			display: flex;
			gap: 10px;
			align-items: center;
			flex-wrap: wrap;
		}

		.flex-row input {
			flex: 1;
			margin-bottom: 0;
		}

		@media (max-width: 768px) {
			.button-group {
				flex-direction: column;
			}

			button {
				width: 100%;
			}

			.flex-row {
				flex-direction: column;
			}

			.flex-row input {
				width: 100%;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>ğŸŒ Express CORS æµ‹è¯•ä¸­å¿ƒ</h1>
			<p>æµ‹è¯•ä¸åŒçš„è·¨æºèµ„æºå…±äº«åœºæ™¯</p>
		</div>

		<div class="content">
			<div class="cors-explanation">
				<h3>ğŸ” å…³äºCORSæµ‹è¯•</h3>
				<ul>
					<li><strong>åŒæºæµ‹è¯•:</strong> å½“å‰é¡µé¢URLä¸API URLç›¸åŒæ—¶ï¼Œä¸ä¼šè§¦å‘CORS</li>
					<li><strong>è·¨æºæµ‹è¯•:</strong> ä½¿ç”¨ä¸åŒç«¯å£æˆ–åŸŸåè®¿é—®æ­¤é¡µé¢æ¥æ¨¡æ‹Ÿè·¨æºè¯·æ±‚</li>
					<li><strong>é¢„æ£€è¯·æ±‚:</strong> å¤æ‚è¯·æ±‚ä¼šå…ˆå‘é€OPTIONSè¯·æ±‚è¿›è¡Œé¢„æ£€</li>
					<li><strong>å‡­æ®æ¨¡å¼:</strong> æµ‹è¯•æ˜¯å¦å¯ä»¥å‘é€cookieså’Œè®¤è¯ä¿¡æ¯</li>
				</ul>
			</div>

			<!-- åŸºæœ¬CORSæµ‹è¯• -->
			<div class="test-section">
				<div class="section-header">
					ğŸ“‹ åŸºæœ¬CORSæµ‹è¯•
				</div>
				<div class="section-content">
					<div class="info">
						<strong>å½“å‰é¡µé¢æº:</strong> <span id="currentOrigin"></span><br>
						<strong>APIæœåŠ¡å™¨:</strong> <span id="apiServer"></span>
					</div>

					<div class="button-group">
						<button onclick="testSimpleRequest()" class="btn-success">ç®€å•GETè¯·æ±‚</button>
						<button onclick="testComplexRequest()" class="btn-warning">å¤æ‚POSTè¯·æ±‚</button>
						<button onclick="testWithCredentials()" class="btn-warning">å¸¦å‡­æ®è¯·æ±‚</button>
						<button onclick="testPublicAPI()" class="btn-success">å…¬å¼€API</button>
						<button onclick="testRestrictedAPI()" class="btn-danger">å—é™API</button>
					</div>

					<div id="basicResult" class="result"></div>
				</div>
			</div>

			<!-- è‡ªå®šä¹‰æºæµ‹è¯• -->
			<div class="test-section">
				<div class="section-header">
					ğŸ¯ è‡ªå®šä¹‰æºæµ‹è¯•
				</div>
				<div class="section-content">
					<div class="info">
						é€šè¿‡ä¿®æ”¹è¯·æ±‚å¤´æ¥æ¨¡æ‹Ÿä¸åŒæºçš„è¯·æ±‚
					</div>

					<div class="flex-row">
						<input type="url" id="customOrigin" placeholder="è¾“å…¥è‡ªå®šä¹‰æºï¼Œå¦‚: http://example.com:8080"
							value="http://unauthorized-domain.com">
						<button onclick="testCustomOrigin()" class="btn-warning">æµ‹è¯•è‡ªå®šä¹‰æº</button>
					</div>

					<div id="customResult" class="result"></div>
				</div>
			</div>

			<!-- ä¸åŒæ–¹æ³•æµ‹è¯• -->
			<div class="test-section">
				<div class="section-header">
					ğŸ”§ HTTPæ–¹æ³•æµ‹è¯•
				</div>
				<div class="section-content">
					<div class="info">
						æµ‹è¯•ä¸åŒHTTPæ–¹æ³•çš„CORSè¡Œä¸º
					</div>

					<div class="button-group">
						<button onclick="testMethod('GET')" class="btn-success">GET</button>
						<button onclick="testMethod('POST')" class="btn-warning">POST</button>
						<button onclick="testMethod('PUT')" class="btn-warning">PUT</button>
						<button onclick="testMethod('DELETE')" class="btn-danger">DELETE</button>
						<button onclick="testMethod('PATCH')" class="btn-warning">PATCH</button>
					</div>

					<div id="methodResult" class="result"></div>
				</div>
			</div>

			<!-- é”™è¯¯å¤„ç†æµ‹è¯• -->
			<div class="test-section">
				<div class="section-header">
					âš ï¸ é”™è¯¯åœºæ™¯æµ‹è¯•
				</div>
				<div class="section-content">
					<div class="info">
						æµ‹è¯•å„ç§CORSé”™è¯¯æƒ…å†µ
					</div>

					<div class="button-group">
						<button onclick="testUnauthorizedOrigin()" class="btn-danger">æœªæˆæƒæº</button>
						<button onclick="testInvalidMethod()" class="btn-danger">ä¸æ”¯æŒçš„æ–¹æ³•</button>
						<button onclick="testMissingHeaders()" class="btn-danger">ç¼ºå°‘å¿…éœ€å¤´</button>
						<button onclick="testNonExistentEndpoint()" class="btn-danger">ä¸å­˜åœ¨çš„ç«¯ç‚¹</button>
					</div>

					<div id="errorResult" class="result"></div>
				</div>
			</div>

			<!-- å®æ—¶ç›‘æ§ -->
			<div class="test-section">
				<div class="section-header">
					ğŸ“ˆ å®æ—¶CORSç›‘æ§
				</div>
				<div class="section-content">
					<div class="info">
						å®æ—¶æ˜¾ç¤ºCORSè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
					</div>

					<div class="button-group">
						<button onclick="startMonitoring()" class="btn-success">å¼€å§‹ç›‘æ§</button>
						<button onclick="stopMonitoring()" class="btn-danger">åœæ­¢ç›‘æ§</button>
						<button onclick="clearMonitoring()">æ¸…é™¤æ—¥å¿—</button>
					</div>

					<div id="monitorResult" class="result"></div>
				</div>
			</div>
		</div>
	</div>

	<script>
		// å…¨å±€å˜é‡
		let monitoringInterval = null;
		const API_BASE = window.location.origin;

		// åˆå§‹åŒ–é¡µé¢ä¿¡æ¯
		document.addEventListener('DOMContentLoaded', function () {
			document.getElementById('currentOrigin').textContent = window.location.origin;
			document.getElementById('apiServer').textContent = API_BASE;
		});

		// é€šç”¨è¯·æ±‚å‡½æ•°
		async function makeRequest (url, options = {}) {
			const startTime = Date.now();

			try {
				const response = await fetch(url, {
					mode: 'cors',
					...options
				});

				const endTime = Date.now();
				const data = await response.json();

				return {
					success: response.ok,
					status: response.status,
					statusText: response.statusText,
					headers: Object.fromEntries(response.headers.entries()),
					data: data,
					responseTime: endTime - startTime,
					url: url,
					method: options.method || 'GET'
				};
			} catch (error) {
				const endTime = Date.now();
				return {
					success: false,
					error: error.message,
					responseTime: endTime - startTime,
					url: url,
					method: options.method || 'GET'
				};
			}
		}

		// æ ¼å¼åŒ–å“åº”ç»“æœ
		function formatResult (result) {
			const statusIcon = result.success ? 'âœ…' : 'âŒ';
			const timestamp = new Date().toLocaleString();

			let output = `${statusIcon} [${timestamp}] ${result.method} ${result.url}\n`;
			output += `çŠ¶æ€: ${result.status || 'ERROR'} ${result.statusText || ''}\n`;
			output += `å“åº”æ—¶é—´: ${result.responseTime}ms\n`;

			if (result.success) {
				output += `CORSå¤´ä¿¡æ¯:\n`;
				const corsHeaders = [
					'access-control-allow-origin',
					'access-control-allow-methods',
					'access-control-allow-headers',
					'access-control-allow-credentials',
					'access-control-max-age'
				];

				corsHeaders.forEach(header => {
					if (result.headers[header]) {
						output += `  ${header}: ${result.headers[header]}\n`;
					}
				});

				output += `\nå“åº”æ•°æ®:\n${JSON.stringify(result.data, null, 2)}\n`;
			} else {
				output += `é”™è¯¯: ${result.error}\n`;
			}

			return output;
		}

		// æ˜¾ç¤ºç»“æœ
		function showResult (elementId, result) {
			const element = document.getElementById(elementId);
			element.textContent = formatResult(result);
			element.className = `result ${result.success ? 'success' : 'error'}`;
		}

		// åŸºæœ¬æµ‹è¯•å‡½æ•°
		async function testSimpleRequest () {
			const result = await makeRequest(`${API_BASE}/api/simple`);
			showResult('basicResult', result);
		}

		async function testComplexRequest () {
			const result = await makeRequest(`${API_BASE}/api/complex`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-Custom-Header': 'test'
				},
				body: JSON.stringify({
					message: 'è¿™æ˜¯ä¸€ä¸ªå¤æ‚è¯·æ±‚æµ‹è¯•',
					timestamp: new Date().toISOString()
				})
			});
			showResult('basicResult', result);
		}

		async function testWithCredentials () {
			const result = await makeRequest(`${API_BASE}/api/protected`, {
				method: 'GET',
				credentials: 'include',
				headers: {
					'Authorization': 'Bearer demo-token-12345'
				}
			});
			showResult('basicResult', result);
		}

		async function testPublicAPI () {
			const result = await makeRequest(`${API_BASE}/api/public`);
			showResult('basicResult', result);
		}

		async function testRestrictedAPI () {
			const result = await makeRequest(`${API_BASE}/api/restricted`);
			showResult('basicResult', result);
		}

		// è‡ªå®šä¹‰æºæµ‹è¯•
		async function testCustomOrigin () {
			const customOrigin = document.getElementById('customOrigin').value;
			const result = await makeRequest(`${API_BASE}/api/simple`, {
				headers: {
					'Origin': customOrigin
				}
			});
			showResult('customResult', result);
		}

		// HTTPæ–¹æ³•æµ‹è¯•
		async function testMethod (method) {
			let options = { method: method };

			if (['POST', 'PUT', 'PATCH'].includes(method)) {
				options.headers = {
					'Content-Type': 'application/json'
				};
				options.body = JSON.stringify({
					test: true,
					method: method,
					timestamp: new Date().toISOString()
				});
			}

			const result = await makeRequest(`${API_BASE}/api/complex`, options);
			showResult('methodResult', result);
		}

		// é”™è¯¯æµ‹è¯•å‡½æ•°
		async function testUnauthorizedOrigin () {
			const result = await makeRequest(`${API_BASE}/api/restricted`, {
				headers: {
					'Origin': 'http://malicious-site.com'
				}
			});
			showResult('errorResult', result);
		}

		async function testInvalidMethod () {
			const result = await makeRequest(`${API_BASE}/api/simple`, {
				method: 'TRACE'
			});
			showResult('errorResult', result);
		}

		async function testMissingHeaders () {
			const result = await makeRequest(`${API_BASE}/api/protected`);
			showResult('errorResult', result);
		}

		async function testNonExistentEndpoint () {
			const result = await makeRequest(`${API_BASE}/api/nonexistent`);
			showResult('errorResult', result);
		}

		// ç›‘æ§åŠŸèƒ½
		function startMonitoring () {
			if (monitoringInterval) {
				stopMonitoring();
			}

			const monitorElement = document.getElementById('monitorResult');
			monitorElement.textContent = 'ğŸ”„ å¼€å§‹ç›‘æ§CORSè¯·æ±‚...\n\n';
			monitorElement.className = 'result';

			let requestCount = 0;

			monitoringInterval = setInterval(async () => {
				requestCount++;
				const result = await makeRequest(`${API_BASE}/api/public`);

				const timestamp = new Date().toLocaleString();
				const status = result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
				const logEntry = `[${timestamp}] è¯·æ±‚ #${requestCount} - ${status} (${result.responseTime}ms)\n`;

				monitorElement.textContent += logEntry;
				monitorElement.scrollTop = monitorElement.scrollHeight;
			}, 2000);
		}

		function stopMonitoring () {
			if (monitoringInterval) {
				clearInterval(monitoringInterval);
				monitoringInterval = null;

				const monitorElement = document.getElementById('monitorResult');
				monitorElement.textContent += '\nğŸ›‘ ç›‘æ§å·²åœæ­¢\n';
			}
		}

		function clearMonitoring () {
			const monitorElement = document.getElementById('monitorResult');
			monitorElement.textContent = '';
			monitorElement.className = 'result';
		}

		// é¡µé¢å¸è½½æ—¶æ¸…ç†
		window.addEventListener('beforeunload', function () {
			if (monitoringInterval) {
				clearInterval(monitoringInterval);
			}
		});
	</script>
</body>

</html>